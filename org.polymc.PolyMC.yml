app-id: org.polymc.PolyMC
runtime: org.kde.Platform
runtime-version: "5.15"
sdk: org.kde.Sdk
command: polymc
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=pulseaudio
    # for Discord RPC mods
  - --filesystem=xdg-run/app/com.discordapp.Discord:create

modules:
  # Compile PolyMC
  - name: compile
    buildsystem: simple
    build-commands:
      - mkdir build
      - mkdir -p /app/bin
      - cd build && JAVA_HOME=/run/build/compile/jdk PATH=$JAVA_HOME:$PATH JAVA_COMPILER=../jdk/bin/javac cmake -DLauncher_LAYOUT=lin-system -DCMAKE_INSTALL_PREFIX=/app/ .. && make -j$(nproc) install
    sources:
      - type: git
        url: https://github.com/PolyMC/PolyMC.git
        tag: 1.0.2
      - type: archive
        url: https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17%2B35/OpenJDK17-jdk_x64_linux_hotspot_17_35.tar.gz
        sha256: 6f1335d9a7855159f982dac557420397be9aa85f3f7bc84e111d25871c02c0c7
        archive-type: tar-gzip
        dest: jdk
      - type: patch
        path: patches-polymc/0001-Fix-DesktopServices.cpp-to-not-crash-when-using-flat.patch
    cleanup: ["/share/applications/polymc.desktop"]
  # old MC versions depend on Xrandr
  - name: xrandr
    buildsystem: autotools
    sources:
      - type: archive
        url: https://xorg.freedesktop.org/archive/individual/app/xrandr-1.5.1.tar.xz
        sha256: 7bc76daf9d72f8aff885efad04ce06b90488a1a169d118dea8a2b661832e8762
    cleanup: ["/share/man", "/bin/xkeystone"]
  # Install Java versions for different minecraft versions
  - name: java
    buildsystem: simple
    build-commands:
      - mkdir -p /app/jdk
      - mv ./* /app/jdk
    sources:
      # JDK 17 for MC 1.18
      - type: archive
        url: https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.1%2B12/OpenJDK17U-jre_x64_linux_hotspot_17.0.1_12.tar.gz
        sha256: 9d58cb741509a88e0ae33eb022334fb900b409b198eca6fe76246f0677b392ad
        strip-components: 0
      # JDK for Minecraft 1.17 - 1.18
      # note: I would like this to be JRE, but I couldnt find a JRE for java 16. Every other version has a build without devtools included.
      - type: archive
        url: https://github.com/adoptium/temurin16-binaries/releases/download/jdk-16.0.2%2B7/OpenJDK16U-jdk_x64_linux_hotspot_16.0.2_7.tar.gz
        sha256: 323d6d7474a359a28eff7ddd0df8e65bd61554a8ed12ef42fd9365349e573c2c
        strip-components: 0
      # JDK 11 for 1.9 - 1.15.2
      - type: archive
        url: https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.13%2B8/OpenJDK11U-jre_x64_linux_hotspot_11.0.13_8.tar.gz
        sha256: fb0a27e6e1f26a1ee79daa92e4cfe3ec0d676acfe114d99dd84b3414f056e8a0
        strip-components: 0
      # JDK 8 for pre1.9
      - type: archive
        url: https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u312-b07/OpenJDK8U-jre_x64_linux_hotspot_8u312b07.tar.gz
        sha256: 18fd13e77621f712326bfcf79c3e3cc08c880e3e4b8f63a1e5da619f3054b063
        strip-components: 0
    cleanup:
      ["/jdk/**/man", "/jdk/**/legal", "/jdk/**/NOTICE", "/jdk/**/release"]
  # Install desktop files and icons
  - name: desktopfiles
    buildsystem: simple
    build-commands:
      - install -Dm644 org.polymc.PolyMC.desktop /app/share/applications/org.polymc.PolyMC.desktop
      - install -Dm644 org.polymc.PolyMC.svg /app/share/icons/org.polymc.PolyMC.svg
    sources:
      - type: file
        path: org.polymc.PolyMC.desktop
      - type: file
        path: org.polymc.PolyMC.svg
  # Prime-Run is a wrapper program for running minecraft with NVIDIA Graphics on a hybrid-gpu device
  - name: prime-run
    buildsystem: simple
    build-commands:
      - install -Dm755 prime-run /app/bin/prime-run
    sources:
      - type: file
        path: prime-run
  - name: libdecor
    buildsystem: meson
    sources:
      - type: archive
        url: https://gitlab.gnome.org/jadahl/libdecor/-/archive/0.1.0/libdecor-0.1.0.tar.gz
        sha256: 1d5758cb49dcb9ceaa979ad14ceb6cdf39282af5ce12ebe6073dd193d6b2fb5e
  # Patched GLFW for Wayland and Minecraft
  - name: glfw
    buildsystem: cmake
    config_opts:
      [
        "-DCMAKE_INSTALL_LIBDIR=lib",
        "-DBUILD_SHARED_LIBS=ON",
        "-DGLFW_USE_WAYLAND=ON",
      ]
    sources:
      - type: archive
        url: https://github.com/glfw/glfw/archive/6876cf8d7e0e70dc3e4d7b0224d08312c9f78099.tar.gz
        sha256: 70dd8d43efc3b7e5d71e687cb94989f9124d8457b834b221ff9e41c5c8feea9f
      - type: patch
        paths:
          - patches-glfw/0001-libdecoration-support.patch
          - patches-glfw/0002-set-O_NONBLOCK-on-repeat-timerfd.patch
          - patches-glfw/0003-wayland-don-t-crash-app-on-api-calls-to-window-focus.patch
          - patches-glfw/0004-fix-broken-opengl-screenshots-on-mutter.patch
    cleanup: ["/share/doc"]
  - name: metainfo
    buildsystem: simple
    build-commands:
      - install -Dm644 org.polymc.PolyMC.metainfo.xml /app/share/metainfo/org.polymc.PolyMC.metainfo.xml
    sources:
      - type: file
        path: org.polymc.PolyMC.metainfo.xml
