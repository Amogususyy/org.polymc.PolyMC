app-id: org.polymc.PolyMC
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
  - org.freedesktop.Sdk.Extension.openjdk8
command: polymc
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=pulseaudio
    # for Discord RPC mods
  - --filesystem=xdg-run/app/com.discordapp.Discord:create

modules:
  # Compile PolyMC
  - name: compile
    buildsystem: simple
    build-commands:
      - mkdir build
      - mkdir -p /app/bin
      - cd build && JAVA_HOME=/run/build/compile/jdk PATH=$JAVA_HOME:$PATH JAVA_COMPILER=../jdk/bin/javac
        cmake -DLauncher_LAYOUT=lin-system -DCMAKE_INSTALL_PREFIX=/app/ .. && make
        -j$(nproc) install
    sources:
      - type: git
        url: https://github.com/PolyMC/PolyMC.git
        tag: 1.0.6
        x-checker-data:
          type: git
        commit: 204e3dca22e5d4f14ded50e1dcd3f0af9ff3d88e
      - type: archive
        url: https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17%2B35/OpenJDK17-jdk_x64_linux_hotspot_17_35.tar.gz
        sha256: 6f1335d9a7855159f982dac557420397be9aa85f3f7bc84e111d25871c02c0c7
        archive-type: tar-gzip
        dest: jdk
      - type: patch
        path: patches/0001-Fix-DesktopServices.cpp-to-not-crash-when-using-flat.patch
    cleanup: [/share/applications/polymc.desktop]
  # old MC versions depend on Xrandr
  - name: openjdk17
    buildsystem: simple
    build-commands:
      - mkdir -p /app/jdk/
      - /usr/lib/sdk/openjdk17/install.sh
      - cp -r /app/jre /app/jdk/17
    cleanup: [/jre]
  - name: openjdk8
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk8/install.sh
      - cp -r /app/jre /app/jdk/8
    cleanup: [/jre]
  - name: xrandr
    buildsystem: autotools
    sources:
      - type: archive
        url: https://xorg.freedesktop.org/archive/individual/app/xrandr-1.5.1.tar.xz
        sha256: 7bc76daf9d72f8aff885efad04ce06b90488a1a169d118dea8a2b661832e8762
    cleanup: [/share/man, /bin/xkeystone]
  # Prime-Run is a wrapper program for running minecraft with NVIDIA Graphics on a hybrid-gpu device
  - name: prime-run
    buildsystem: simple
    build-commands:
      - install -Dm755 prime-run /app/bin/prime-run
    sources:
      - type: file
        path: prime-run
  - name: libdecor
    buildsystem: meson
    sources:
      - type: archive
        url: https://gitlab.gnome.org/jadahl/libdecor/-/archive/0.1.0/libdecor-0.1.0.tar.gz
        sha256: 1d5758cb49dcb9ceaa979ad14ceb6cdf39282af5ce12ebe6073dd193d6b2fb5e
  # Patched GLFW for Wayland and Minecraft
  - name: glfw
    buildsystem: cmake
    config_opts: [-DCMAKE_INSTALL_LIBDIR=lib, -DBUILD_SHARED_LIBS=ON, -DGLFW_USE_WAYLAND=ON]
    sources:
      - type: git
        url: https://github.com/glfw/glfw.git
        commit: 87d5646f5d2bad0562744501633bf8105f59c193
      - type: patch
        paths:
          - glfw-patches/0001-Wayland-Set-O_NONBLOCK-on-repeat-timerfd.patch
          - glfw-patches/0002-Wayland-Continue-poll-if-timerfd-can-t-be-read.patch
          - glfw-patches/0003-Don-t-crash-on-calls-to-focus-or-icon.patch
          - glfw-patches/0004-wayland-fix-broken-opengl-screenshots-on-mutter.patch
          - glfw-patches/0005-Add-warning-about-being-an-unofficial-patch.patch
          - glfw-patches/0006-Don-t-crash-getting-scancode-name.patch
          - glfw-patches/0007-libdecor-proper-decorations-with-title-and-window-bu.patch
          - glfw-patches/0008-Add-libdecoration-marker-to-stderr-warning.patch
          - glfw-patches/0009-Wayland-Fix-cursor-offset-when-shape-changes.patch
    cleanup: [/share/doc]
